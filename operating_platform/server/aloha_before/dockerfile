# 使用 Ubuntu 20.04 基础镜像
FROM ubuntu:20.04

# 配置时区（避免 apt 安装阻塞）
ENV DEBIAN_FRONTEND=noninteractive TZ=Etc/UTC
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        wget bzip2 ca-certificates \
        libgl1-mesa-glx libglib2.0-0 libsm6 libxext6 libxrender1 && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# 安装 Miniconda（国内镜像加速）
RUN wget -q https://mirrors.bfsu.edu.cn/anaconda/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh && \
    bash miniconda.sh -b -p /opt/miniconda && \
    rm miniconda.sh

# 设置全局 PATH
ENV PATH="/opt/miniconda/bin:$PATH"

# 创建 Conda 环境（从 YAML 文件）
WORKDIR /app
COPY environment.yml .
RUN conda env create -f environment.yml

# 安装纯 pip 依赖（分离 Conda 与 pip 管理）
COPY requirements.txt .
RUN /opt/miniconda/envs/op/bin/pip install --no-cache-dir -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple

# 设置运行时环境变量（关键！）
ENV PATH="/opt/miniconda/envs/op/bin:$PATH"

# 创建代码目录（避免挂载时覆盖 /app）
RUN mkdir -p /app/code
WORKDIR /app/code  

EXPOSE 8080
CMD ["python", "operating_platform_server_test.py", "--log-output=stdout"]